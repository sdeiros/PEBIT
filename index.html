<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Sender</title>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>

<h1>Email Sender</h1>

<label for="subject">Assunto:</label>
<input type="text" id="subject" placeholder="Digite o assunto do e-mail">

<label for="body">Corpo:</label>
<textarea id="body" placeholder="Digite o corpo do e-mail"></textarea>

<button onclick="sendEmails()">Enviar E-mails</button>

<div id="status"></div>

<script>
    const SPREADSHEET_ID = '1WAxnZPqgbTAvqtTampi34xDkL-3-W13mnbIo2ACcIm4';
    const RANGE = 'Sheet1!B:B';
    const API_KEY = 'AIzaSyDq1_3tOQdeM3besaeg1-O4coztRsL3FZY';

    function authenticateAndLoadData() {
        gapi.load('client:auth2', initClient);
    }

    function initClient() {
        gapi.client.init({
            apiKey: API_KEY,
            clientId: '654124595412-qmi2ogeis2q2k9riq7dbvu9vqft17f4j.apps.googleusercontent.com',
            discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
            scope: 'https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/gmail.send',
        }).then(function () {
            gapi.auth2.getAuthInstance().signIn().then(() => {
                // Não é mais necessário carregar dados aqui
            });
        });
    }

    async function sendEmails() {
        const subject = document.getElementById('subject').value;
        const body = document.getElementById('body').value;
        const statusElement = document.getElementById('status');

        try {
            // Obter dados da planilha
            const sheetUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
            const sheetResponse = await fetch(sheetUrl);
            const sheetData = await sheetResponse.json();

            if (sheetData.values && sheetData.values.length > 1) {
                const emailColumn = sheetData.values.slice(1).map(row => row[0]); // Ignora o cabeçalho
                await sendEmailToAll(emailColumn, subject, body);
                statusElement.textContent = 'E-mails enviados com sucesso.';
                console.log('E-mails enviados com sucesso.');
            } else {
                statusElement.textContent = 'Nenhum dado encontrado na planilha.';
                console.error('Nenhum dado encontrado na planilha.');
            }
        } catch (error) {
            statusElement.textContent = `Erro ao acessar a planilha: ${error.message}`;
            console.error('Erro ao acessar a planilha:', error.message);
        }
    }

    async function sendEmailToAll(emails, subject, body) {
        const statusElement = document.getElementById('status');

        for (const email of emails) {
            // Adicione a lógica para enviar e-mails aqui
            // Utilize a API do Gmail para enviar e-mails

            const message = createMessage('SEU_EMAIL@gmail.com', email, subject, body);

            try {
                const response = await sendMessage(message);
                statusElement.textContent = `E-mail enviado para: ${email}`;
                console.log(`E-mail enviado para: ${email}`, response);
            } catch (error) {
                statusElement.textContent = `Erro ao enviar e-mail para ${email}: ${error.message}`;
                console.error(`Erro ao enviar e-mail para ${email}:`, error.message);
            }
        }
    }

    function createMessage(sender, to, subject, body) {
        const email = [
            'Content-Type: text/plain; charset="UTF-8"\n',
            'MIME-Version: 1.0\n',
            `To: ${to}\n`,
            `From: ${sender}\n`,
            `Subject: ${subject}\n\n`,
            body,
        ].join('');

        return btoa(email);
    }

    async function sendMessage(message) {
        const response = await gapi.client.gmail.users.messages.send({
            userId: 'me',
            resource: {
                raw: message,
            },
        });
        return response.result;
    }
</script>

</body>
</html>
